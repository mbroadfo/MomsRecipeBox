{
  "info": {
    "name": "MomsRecipeBox - Admin API",
    "description": "Admin endpoints for user management in MomsRecipeBox. Requires Auth0 JWT authentication with admin permissions.",
    "version": "1.0.0",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{auth0_admin_jwt}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3000",
      "type": "string",
      "description": "Base URL for the MomsRecipeBox API"
    },
    {
      "key": "auth0_admin_jwt",
      "value": "your_auth0_jwt_token_here",
      "type": "string",
      "description": "Auth0 JWT token with admin permissions (admin:read, admin:write)"
    },
    {
      "key": "test_user_id",
      "value": "auth0|test123",
      "type": "string",
      "description": "Test user ID for delete operations"
    },
    {
      "key": "test_email",
      "value": "test@example.com",
      "type": "string",
      "description": "Test email for user invitation"
    }
  ],
  "item": [
    {
      "name": "Admin User Management",
      "description": "Endpoints for managing users through Auth0",
      "item": [
        {
          "name": "List Users",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{auth0_admin_jwt}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/users?page=1&per_page=10",
              "host": ["{{base_url}}"],
              "path": ["admin", "users"],
              "query": [
                {
                  "key": "page",
                  "value": "1",
                  "description": "Page number (default: 1)"
                },
                {
                  "key": "per_page",
                  "value": "10",
                  "description": "Users per page (default: 10, max: 100)"
                },
                {
                  "key": "search",
                  "value": "",
                  "description": "Search by email",
                  "disabled": true
                }
              ]
            },
            "description": "Retrieve a paginated list of users with statistics.\n\n**Required Permission:** `admin:read`\n\n**Response includes:**\n- User list with basic info\n- Pagination metadata\n- User statistics (total users, active users, new users this month)"
          },
          "response": [
            {
              "name": "Success Response",
              "originalRequest": {
                "method": "GET",
                "header": [
                  {
                    "key": "Authorization",
                    "value": "Bearer {{auth0_admin_jwt}}",
                    "type": "text"
                  }
                ],
                "url": {
                  "raw": "{{base_url}}/admin/users?page=1&per_page=10",
                  "host": ["{{base_url}}"],
                  "path": ["admin", "users"],
                  "query": [
                    {
                      "key": "page",
                      "value": "1"
                    },
                    {
                      "key": "per_page",
                      "value": "10"
                    }
                  ]
                }
              },
              "status": "OK",
              "code": 200,
              "header": [
                {
                  "key": "Content-Type",
                  "value": "application/json"
                }
              ],
              "body": "{\n  \"users\": [\n    {\n      \"user_id\": \"auth0|67e1cc293eeee752d79bfd3a\",\n      \"email\": \"user@example.com\",\n      \"name\": \"John Doe\",\n      \"created_at\": \"2024-01-01T00:00:00.000Z\",\n      \"logins_count\": 25,\n      \"last_login\": \"2024-01-15T10:30:00.000Z\",\n      \"email_verified\": true\n    }\n  ],\n  \"pagination\": {\n    \"page\": 1,\n    \"per_page\": 10,\n    \"total\": 50,\n    \"total_pages\": 5\n  },\n  \"stats\": {\n    \"total_users\": 50,\n    \"active_users\": 45,\n    \"new_users_this_month\": 8\n  }\n}"
            }
          ]
        },
        {
          "name": "Invite User",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{auth0_admin_jwt}}",
                  "type": "string"
                }
              ]
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{test_email}}\",\n  \"name\": \"Test User\",\n  \"role\": \"user\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{base_url}}/admin/users/invite",
              "host": ["{{base_url}}"],
              "path": ["admin", "users", "invite"]
            },
            "description": "Invite a new user to the application.\n\n**Required Permission:** `admin:write`\n\n**Request Body:**\n- `email` (required): User's email address\n- `name` (required): User's full name\n- `role` (optional): User role (default: 'user')\n\n**Response:**\n- Created user information\n- Success message"
          },
          "response": [
            {
              "name": "Success Response",
              "originalRequest": {
                "method": "POST",
                "header": [
                  {
                    "key": "Authorization",
                    "value": "Bearer {{auth0_admin_jwt}}",
                    "type": "text"
                  },
                  {
                    "key": "Content-Type",
                    "value": "application/json",
                    "type": "text"
                  }
                ],
                "body": {
                  "mode": "raw",
                  "raw": "{\n  \"email\": \"newuser@example.com\",\n  \"name\": \"New User\",\n  \"role\": \"user\"\n}",
                  "options": {
                    "raw": {
                      "language": "json"
                    }
                  }
                },
                "url": {
                  "raw": "{{base_url}}/admin/users/invite",
                  "host": ["{{base_url}}"],
                  "path": ["admin", "users", "invite"]
                }
              },
              "status": "Created",
              "code": 201,
              "header": [
                {
                  "key": "Content-Type",
                  "value": "application/json"
                }
              ],
              "body": "{\n  \"message\": \"User invitation sent successfully\",\n  \"user\": {\n    \"user_id\": \"auth0|new123456789\",\n    \"email\": \"newuser@example.com\",\n    \"name\": \"New User\",\n    \"created_at\": \"2024-01-16T12:00:00.000Z\",\n    \"email_verified\": false\n  }\n}"
            }
          ]
        },
        {
          "name": "Delete User",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{auth0_admin_jwt}}",
                  "type": "string"
                }
              ]
            },
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/users/{{test_user_id}}",
              "host": ["{{base_url}}"],
              "path": ["admin", "users", "{{test_user_id}}"]
            },
            "description": "Delete a user account permanently.\n\n**Required Permission:** `admin:write`\n\n**Path Parameter:**\n- `user_id`: The Auth0 user ID (e.g., auth0|123456789)\n\n**Response:**\n- Success message\n- Deleted user ID\n\n**âš ï¸ Warning:** This action is irreversible!"
          },
          "response": [
            {
              "name": "Success Response",
              "originalRequest": {
                "method": "DELETE",
                "header": [
                  {
                    "key": "Authorization",
                    "value": "Bearer {{auth0_admin_jwt}}",
                    "type": "text"
                  }
                ],
                "url": {
                  "raw": "{{base_url}}/admin/users/auth0|test123",
                  "host": ["{{base_url}}"],
                  "path": ["admin", "users", "auth0|test123"]
                }
              },
              "status": "OK",
              "code": 200,
              "header": [
                {
                  "key": "Content-Type",
                  "value": "application/json"
                }
              ],
              "body": "{\n  \"message\": \"User deleted successfully\",\n  \"user_id\": \"auth0|test123\"\n}"
            }
          ]
        }
      ]
    },
    {
      "name": "Authentication & Testing",
      "description": "Helper endpoints for authentication testing",
      "item": [
        {
          "name": "Get M2M Token",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"grant_type\": \"client_credentials\",\n  \"client_id\": \"{{auth0_m2m_client_id}}\",\n  \"client_secret\": \"{{auth0_m2m_client_secret}}\",\n  \"audience\": \"https://momsrecipebox/api\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "https://{{auth0_domain}}/oauth/token",
              "protocol": "https",
              "host": ["{{auth0_domain}}"],
              "path": ["oauth", "token"]
            },
            "description": "Get Auth0 M2M token for admin API access.\n\n**Required Environment Variables:**\n- `auth0_m2m_client_id`: Your Auth0 M2M Client ID\n- `auth0_m2m_client_secret`: Your Auth0 M2M Client Secret\n- `auth0_domain`: Your Auth0 domain\n\n**This request automatically:**\n1. Gets the M2M token from Auth0 with the correct API audience\n2. Sets it in the `auth0_admin_jwt` environment variable\n3. Makes it available for all other admin requests\n\n**âœ… CORRECT AUDIENCE:** Uses https://momsrecipebox/api audience that matches your Auth0 API.\n\n**Requirements:** Your M2M app must be authorized for the 'Moms Recipe Box API' in Auth0 Dashboard."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// Automatically extract and set the M2M token",
                  "pm.test('M2M Token Response', function () {",
                  "    pm.response.to.have.status(200);",
                  "    ",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson).to.have.property('access_token');",
                  "    pm.expect(responseJson).to.have.property('token_type', 'Bearer');",
                  "    ",
                  "    // Automatically set the token in environment",
                  "    const token = responseJson.access_token;",
                  "    pm.environment.set('auth0_admin_jwt', token);",
                  "    ",
                  "    console.log('âœ… M2M Token obtained and set in environment');",
                  "    console.log('ðŸ“ Token length:', token.length, 'characters');",
                  "    console.log('â° Expires in:', responseJson.expires_in, 'seconds');",
                  "    console.log('ðŸŽ¯ Token type:', responseJson.token_type);",
                  "    console.log('');",
                  "    console.log('ðŸš€ Ready to test admin endpoints!');",
                  "});",
                  "",
                  "// Check if credentials are configured",
                  "pm.test('M2M Credentials Check', function () {",
                  "    const clientId = pm.environment.get('auth0_m2m_client_id');",
                  "    const clientSecret = pm.environment.get('auth0_m2m_client_secret');",
                  "    ",
                  "    if (!clientId || !clientSecret) {",
                  "        pm.expect.fail('M2M credentials not configured in environment variables');",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "response": []
        },
        {
          "name": "Test Authentication",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "{{auth0_admin_jwt}}",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/admin/users?per_page=1",
              "host": ["{{base_url}}"],
              "path": ["admin", "users"],
              "query": [
                {
                  "key": "per_page",
                  "value": "1"
                }
              ]
            },
            "description": "Quick test to verify your JWT token is working.\n\nThis endpoint requires valid Auth0 authentication and admin permissions.\n\n**Expected responses:**\n- 200: Authentication successful\n- 401: Invalid or missing JWT token\n- 403: Insufficient permissions"
          }
        },
        {
          "name": "Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/health",
              "host": ["{{base_url}}"],
              "path": ["health"]
            },
            "description": "Check if the API server is running (no authentication required)."
          }
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// ENHANCED DEBUG - Check all variable sources",
          "console.log('ðŸ” DETAILED VARIABLE DEBUG:');",
          "console.log('==========================================');",
          "",
          "// Check environment variables",
          "const envClientId = pm.environment.get('auth0_m2m_client_id');",
          "const envClientSecret = pm.environment.get('auth0_m2m_client_secret');",
          "const envDomain = pm.environment.get('auth0_domain');",
          "",
          "// Check collection variables",
          "const collClientId = pm.collectionVariables.get('auth0_m2m_client_id');",
          "const collClientSecret = pm.collectionVariables.get('auth0_m2m_client_secret');",
          "",
          "// Check globals",
          "const globalClientId = pm.globals.get('auth0_m2m_client_id');",
          "const globalClientSecret = pm.globals.get('auth0_m2m_client_secret');",
          "",
          "console.log('ðŸ“Š ENVIRONMENT VARIABLES:');",
          "console.log('   auth0_m2m_client_id:', envClientId ? 'âœ… SET (' + envClientId.length + ' chars)' : 'âŒ NOT SET');",
          "console.log('   auth0_m2m_client_secret:', envClientSecret ? 'âœ… SET (' + envClientSecret.length + ' chars)' : 'âŒ NOT SET');",
          "console.log('   auth0_domain:', envDomain || 'âŒ NOT SET');",
          "",
          "console.log('ï¿½ COLLECTION VARIABLES:');",
          "console.log('   auth0_m2m_client_id:', collClientId ? 'âœ… SET (' + collClientId.length + ' chars)' : 'âŒ NOT SET');",
          "console.log('   auth0_m2m_client_secret:', collClientSecret ? 'âœ… SET (' + collClientSecret.length + ' chars)' : 'âŒ NOT SET');",
          "",
          "console.log('ðŸ“Š GLOBAL VARIABLES:');",
          "console.log('   auth0_m2m_client_id:', globalClientId ? 'âœ… SET (' + globalClientId.length + ' chars)' : 'âŒ NOT SET');",
          "console.log('   auth0_m2m_client_secret:', globalClientSecret ? 'âœ… SET (' + globalClientSecret.length + ' chars)' : 'âŒ NOT SET');",
          "",
          "console.log('ðŸŽ¯ CURRENT REQUEST:', pm.info.requestName);",
          "console.log('ðŸŒ CURRENT ENVIRONMENT:', pm.environment.name);",
          "console.log('==========================================');",
          "",
          "// Check if JWT token is set",
          "const token = pm.environment.get('auth0_admin_jwt') || pm.collectionVariables.get('auth0_admin_jwt');",
          "const clientId = pm.environment.get('auth0_m2m_client_id');",
          "const clientSecret = pm.environment.get('auth0_m2m_client_secret');",
          "",
          "// Skip token check for the Get M2M Token request itself",
          "if (pm.info.requestName === 'Get M2M Token') {",
          "    if (!clientId || !clientSecret) {",
          "        console.error('âŒ M2M CREDENTIALS NOT SET!');",
          "        console.log('');",
          "        console.log('ðŸ”§ TO FIX THIS:');",
          "        console.log('1. In Postman environment, set auth0_m2m_client_id');",
          "        console.log('2. In Postman environment, set auth0_m2m_client_secret');",
          "        console.log('3. Get these from your Auth0 Dashboard â†’ Applications â†’ M2M App');",
          "        console.log('4. Make sure variables are set in ENVIRONMENT (not collection)');",
          "        console.log('5. Check variable names are exactly: auth0_m2m_client_id and auth0_m2m_client_secret');",
          "        console.log('6. Verify you have selected the correct environment in Postman');",
          "    } else {",
          "        console.log('âœ… M2M credentials are configured');",
          "    }",
          "    return; // Skip JWT check for token request",
          "}",
          "",
          "if (!token || token === '' || token === 'your_auth0_jwt_token_here') {",
          "    console.error('âŒ AUTH0 JWT TOKEN NOT SET!');",
          "    console.log('');",
          "    console.log('ðŸ”§ TO FIX THIS:');",
          "    console.log('1. First, set your M2M credentials in environment variables');",
          "    console.log('2. Run the \"Get M2M Token\" request to automatically get and set the JWT');",
          "    console.log('3. Then run your admin API requests');",
          "    console.log('');",
          "    console.log('ðŸ’¡ The M2M approach is secure and automatic!');",
          "    pm.test('JWT Token Configuration', function () {",
          "        pm.expect.fail('JWT token not configured. Run \"Get M2M Token\" first.');",
          "    });",
          "} else if (!token.startsWith('eyJ')) {",
          "    console.error('âŒ INVALID TOKEN FORMAT!');",
          "    console.log('Token should start with \"eyJ\" but starts with:', token.substring(0, 10));",
          "    pm.test('JWT Token Format', function () {",
          "        pm.expect.fail('Invalid JWT token format. Run \"Get M2M Token\" to refresh.');",
          "    });",
          "} else {",
          "    console.log('âœ… JWT token configured correctly');",
          "    console.log('ðŸ“ Token length:', token.length, 'characters');",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Common response checks",
          "pm.test('Response time is reasonable', function () {",
          "    pm.expect(pm.response.responseTime).to.be.below(5000);",
          "});",
          "",
          "// Check for authentication errors",
          "if (pm.response.code === 401) {",
          "    pm.test('Authentication error detected', function () {",
          "        console.error('âŒ Authentication failed. Check your JWT token.');",
          "        pm.expect.fail('Invalid JWT token - please update your auth0_admin_jwt variable');",
          "    });",
          "}",
          "",
          "if (pm.response.code === 403) {",
          "    pm.test('Authorization error detected', function () {",
          "        console.error('âŒ Insufficient permissions. Ensure your JWT has admin permissions.');",
          "        pm.expect.fail('Insufficient permissions - admin:read and admin:write required');",
          "    });",
          "}",
          "",
          "// Success response checks",
          "if (pm.response.code >= 200 && pm.response.code < 300) {",
          "    pm.test('Response is JSON', function () {",
          "        pm.response.to.be.json;",
          "    });",
          "",
          "    pm.test('Response has expected content-type', function () {",
          "        pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json');",
          "    });",
          "}"
        ]
      }
    }
  ]
}
